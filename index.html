<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aplikasi Catatan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; }
    .input-area {
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
      padding: 10px;
      box-sizing: border-box;
    }
    .drop-area {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      cursor: pointer;
      position: relative;
    }
    .preview {
      max-width: 200px;
      margin-top: 10px;
    }
    button {
      margin-right: 10px;
      padding: 8px 15px;
      cursor: pointer;
    }
    .note {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fafafa;
    }
    .note img {
      max-width: 100%;
      height: auto;
    }
    .note-actions {
      margin-top: 10px;
    }
    .paste-instructions {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìù Aplikasi Catatan</h1>

    <div class="input-area">
      <textarea id="noteText" placeholder="Tulis catatan Anda di sini..."></textarea>
      <div class="drop-area" id="dropArea">
        Klik atau tarik gambar ke sini<br>
        <span class="paste-instructions">Atau paste screenshot dengan Ctrl+V / Cmd+V</span>
      </div>
      <img id="imagePreview" class="preview" style="display:none;" />
      <input type="file" id="fileInput" accept="image/*" style="display:none;" />
      <button onclick="addNote()">Tambah Catatan</button>
    </div>

    <div id="notesContainer"></div>
  </div>

  <script>
    // Load jsPDF
    const { jsPDF } = window.jspdf;

    // DOM Elements
    const noteText = document.getElementById('noteText');
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const notesContainer = document.getElementById('notesContainer');

    let selectedImage = null;

    // Handle paste event for screenshots
    document.addEventListener('paste', function(e) {
      const items = e.clipboardData?.items;
      if (!items) return;
      
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const blob = items[i].getAsFile();
          if (blob) {
            handlePastedImage(blob);
            e.preventDefault();
            break;
          }
        }
      }
    });

    function handlePastedImage(blob) {
      selectedImage = blob;
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(blob);
    }

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropArea.style.borderColor = '#666';
    }

    function unhighlight() {
      dropArea.style.borderColor = '#ccc';
    }

    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length) handleFiles(files);
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length) handleFiles(files);
    }

    function handleFiles(files) {
      const file = files[0];
      if (!file.type.match('image.*')) return;
      selectedImage = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // Load notes from localStorage on start
    let notes = JSON.parse(localStorage.getItem('notes')) || [];

    function saveNotes() {
      localStorage.setItem('notes', JSON.stringify(notes));
    }

    function addNote() {
      const text = noteText.value.trim();
      if (!text && !selectedImage) return alert('Masukkan teks atau gambar!');

      const createdAt = new Date().toLocaleString('id-ID', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const note = {
        id: Date.now(),
        text: text,
        image: selectedImage ? URL.createObjectURL(selectedImage) : null,
        createdAt: createdAt
      };

      notes.push(note);
      saveNotes();
      renderNotes();
      clearInputs();
    }

    function deleteNote(id) {
      notes = notes.filter(note => note.id !== id);
      saveNotes();
      renderNotes();
    }

    function downloadAsTXT(note) {
      let content = '';
      if (note.text) {
        content += note.text + '\n\n';
      }
      content += `Dibuat: ${note.createdAt}`;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `catatan_${note.id}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadAsPDF(note) {
      const doc = new jsPDF();
      let y = 20;

      // Add title
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('Catatan', 15, y);
      y += 15;

      // Add creation date
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Dibuat: ${note.createdAt}`, 15, y);
      y += 10;

      // Add horizontal line
      doc.setDrawColor(200, 200, 200);
      doc.line(15, y, 195, y);
      y += 15;

      // Add text content
      if (note.text) {
        doc.setFontSize(12);
        const textLines = doc.splitTextToSize(note.text, 170);
        doc.text(textLines, 15, y);
        y += (textLines.length * 7);
      }

      // Add image if exists
      if (note.image) {
        const img = new Image();
        img.src = note.image;
        
        img.onload = function() {
          const maxWidth = 170;
          const maxHeight = 100;
          let imgWidth = img.width;
          let imgHeight = img.height;
          
          // Scale image to fit
          if (imgWidth > maxWidth) {
            const ratio = maxWidth / imgWidth;
            imgWidth = maxWidth;
            imgHeight = imgHeight * ratio;
          }
          if (imgHeight > maxHeight) {
            const ratio = maxHeight / imgHeight;
            imgHeight = maxHeight;
            imgWidth = imgWidth * ratio;
          }
          
          // Check if image fits on current page
          if (y + imgHeight > 280) {
            doc.addPage();
            y = 20;
          }
          
          doc.addImage(img, 'JPEG', 15, y + 10, imgWidth, imgHeight);
          doc.save(`catatan_${note.id}.pdf`);
        };
        
        img.onerror = function() {
          // If image fails to load, just save the PDF with text
          doc.save(`catatan_${note.id}.pdf`);
        };
      } else {
        doc.save(`catatan_${note.id}.pdf`);
      }
    }

    function renderNotes() {
      notesContainer.innerHTML = '';
      notes.forEach(note => {
        const div = document.createElement('div');
        div.className = 'note';
        
        // Create download functions that capture the current note
        const downloadTXT = () => downloadAsTXT(note);
        const downloadPDF = () => downloadAsPDF(note);
        const deleteBtn = () => deleteNote(note.id);
        
        div.innerHTML = `
          ${note.text ? `<p>${note.text}</p>` : ''}
          ${note.image ? `<img src="${note.image}" alt="Gambar catatan" />` : ''}
          <small>Dibuat: ${note.createdAt}</small>
          <div class="note-actions">
            <button class="download-txt-btn">Unduh TXT</button>
            <button class="download-pdf-btn">Unduh PDF</button>
            <button class="delete-btn" style="background:#f44336;color:white;">Hapus</button>
          </div>
        `;
        
        notesContainer.appendChild(div);
        
        // Add event listeners to the buttons
        const buttons = div.querySelectorAll('button');
        buttons[0].addEventListener('click', downloadTXT);
        buttons[1].addEventListener('click', downloadPDF);
        buttons[2].addEventListener('click', deleteBtn);
      });
    }

    function clearInputs() {
      noteText.value = '';
      selectedImage = null;
      imagePreview.style.display = 'none';
      fileInput.value = '';
    }

    // Auto-save on page unload
    window.addEventListener('beforeunload', saveNotes);

    // Initial render
    renderNotes();
  </script>
</body>
</html>

